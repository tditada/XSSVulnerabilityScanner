package challenge;

import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.ListIterator;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

/**
 * @author tere
 *
 */
public class ParametersParser {

	/** Gets the implicit parameters for the GET/POST
	 * @param url
	 * @return Form - method, action and names for the parameters. See @Form
	 * @throws IOException
	 * @throws NoFormException
	 */
	public static Form parsingForm(String url) throws IOException{
		Document doc = Jsoup.connect(url).get();
		Elements form = doc.select("form");
		
		if (form!=null){
			Elements inputs = form.select("input");
			List<String> parameters = new LinkedList<String>();
			Elements textsAreas = form.select("textarea");
			String method = form.attr("method"); // GET or POST
			String action = form.attr("action"); // path to attack!
	
			ListIterator<Element> itrInputs = inputs.listIterator();
			
			while (itrInputs.hasNext()) {
				Element element = itrInputs.next();
				// TODO: DO I NEED THE TYPE?
				String name = element.attr("name");
				if(!name.equals("")){
					parameters.add(name);
				}
			}
	
			ListIterator<Element> itrAreas = textsAreas.listIterator();
			while (itrAreas.hasNext()) {
				Element element = itrAreas.next();
				String name = element.attr("name");
				if(!name.equals(null)){
					parameters.add(name);
				}
			}
			return new Form(method, action, parameters);
		}else{
			System.out.println("No forms in"+url);
			return null;
		}
	}
	
	public static String getUrlParams(Form form, List<String> values) throws IOException{

		StringBuffer urlParamsBuffer = new StringBuffer();
		List<String> params = form.getParameters();	
		if(values.size() <= params.size()){
			for(int j=values.size(); j<params.size();j++){
				values.add("");
			}
		}
		
		for(int i=0; i<params.size();i++){
			urlParamsBuffer.append(params.get(i)+"="+values.get(i)+"&");
		}
		String urlParam = urlParamsBuffer.toString();
		urlParam = urlParam.substring(0, urlParam.length()-1);
		
		return urlParam;
	}

	public static void main(String[] args) throws IOException {
		//String url = "https://google-gruyere.appspot.com/226866433183/editprofile.gtl";
		String url = "https://google-gruyere.appspot.com/226866433183/newsnippet.gtl";
		Form form = parsingForm(url);
		
		List<String> values = new LinkedList<String>();
		int paramsCant = form.getParamsCant();
		for (int i=0; i<paramsCant;i++){
			values.add(Integer.toString(i));
		}
		
		System.out.println(getUrlParams(form, values));
	}
}
