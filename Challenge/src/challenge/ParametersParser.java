package challenge;

import java.io.IOException;
import java.util.LinkedList;
import java.util.List;
import java.util.ListIterator;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

/**
 * @author tere
 *
 */
public class ParametersParser {

	/** Gets the implicit parameters for the GET/POST
	 * @param url
	 * @return Form - method, action and names for the parameters. See @Form
	 * @throws IOException
	 * @throws NoFormException
	 */
	public static Form parsingForm(String url) throws IOException, NoFormException {
		Document doc = Jsoup.connect(url).get();
		Elements form = doc.select("form");
		
		if (form!=null){
			Elements inputs = form.select("input");
			List<String> parameters = new LinkedList<String>();
			Elements textsAreas = form.select("textarea");
			String method = form.attr("method"); // GET or POST
			String action = form.attr("action"); // path to attack!
	
			ListIterator<Element> itrInputs = inputs.listIterator();
			
			while (itrInputs.hasNext()) {
				Element element = itrInputs.next();
				// TODO: DO I NEED THE TYPE?
				String name = element.attr("name");
				if(!name.equals("")){
					parameters.add(name);
				}
			}
	
			ListIterator<Element> itrAreas = textsAreas.listIterator();
			while (itrAreas.hasNext()) {
				Element element = itrAreas.next();
				String name = element.attr("name");
				if(!name.equals(null)){
					parameters.add(name);
				}
			}
			return new Form(method, action, parameters);
		}else{
			throw new NoFormException("No forms in"+url);
		}
	}

	public static void main(String[] args) throws IOException, NoFormException {
		parsingForm("https://google-gruyere.appspot.com/226866433183/editprofile.gtl");

	}
}
